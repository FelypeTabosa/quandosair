<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Quando Sair?</title>
	<link rel='icon' href="https://images.vexels.com/media/users/3/131904/isolated/preview/314ac7a195e5759f2cfadde070a92cc7-reloading-timer-clock-icon-by-vexels.png">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
	<script type="text/javascript">
		var app = angular.module('minhaCalculadoraDeHoras', []);
		app.controller('CalculadoraDeHora', function($scope, $http) {
			//inicializa hora e dados
			$scope.hora = {
				"horasParaTrabalhar":0,
				"minutosParaTrabalhar":0,
				"horaDeEntrada":0,
				"minutosDeEntrada":0,
				"horaDeSaidaAlmoco":0,
				"minutosDeSaidaAlmoco":0,
				"horaDeChegadaAlmoco":0,
				"minutosDeChegadaAlmoco":0
			};
			$scope.temAlmoco = false;
			$scope.temLanche = false;
			angular.element('.error').hide();
			angular.element('.menu').hide();
			angular.element('.div-box').hide();
			angular.element('.resultado').hide();
			angular.element('h3#lanche').hide();
			angular.element('h3#almoco').hide();
			
			//Verifica Campos 
			angular.element('.div-box-button').mouseenter(function(){
				$scope.verificaCampos();
			});
			
			//Mostra Menu
			angular.element('.options').hover(function(){
				angular.element('.menu').show();
				angular.element('.menu').mouseleave(function(){
					angular.element('.menu').fadeOut();
				});
			});
			//Mostra Itens do Menu
			angular.element('.options').hover(function(){
				angular.element('.menu').show();
				angular.element('.menu').mouseleave(function(){
					angular.element('.menu').fadeOut();
				});
			});
			
			//Altera Tipo dos Campos
			$scope.trocaTipoDoCampo = function(){
				angular.element('input').bind('blur',function($event){
					angular.element($event.target).attr("type","text");
					angular.element($event.target).css("padding", "8px 15px");
				});
				angular.element('input').bind('focus',function($event){
					angular.element($event.target).attr("type","time");
					angular.element($event.target).css("padding", "5px 0px 5px 30px");
				});
			}
			//Limpa Campos dependentes Após Alteração da Hora de Entrada 
			angular.element('#horaDeEntrada').change(function(){
				angular.element('.almoco-form input').val("");
				angular.element('.lanche-form input').val("");
			});
			
			$scope.trocaTipoDoCampo();
			
			//Cria Html da div lanche
			$scope.DivLancheHtml = function(){
				return '<div class="div-box div light-blue-opacity lanche-form" style="">'
					+'<input id="horaDeSaidaLanche" class="input-box margin-bottom-15px ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Saída p/ Lanche" title="Hora de Saída p/ Lanche"><br>'
					+'<input id="horaDeChegadaLanche" class="input-box ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Chegada do Lanche" title="Hora de Chegada do Lanche"><br>'
					+'<span class="remove" ng-click="remove($event)"></span></div>';
			}
			//Cria Html da div Almoco
			$scope.DivAlmocoHtml = function(){
				return '<div class="div-box div light-blue-opacity almoco-form" style="">'
					+'<input id="horaDeSaidaAlmoco" class="input-box margin-bottom-15px ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Saída p/ Almoco" title="Hora de Saída p/ Almoco"><br>'
					+'<input id="horaDeChegadaAlmoco" class="input-box ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Chegada do Almoco" title="Hora de Chegada do Almoco" min="10:00" max="12:00"><br>'
					+'<span class="remove" ng-click="remove($event)"></span></div>';
			}
			
			//Funções que adiciona almoço e lanche
			angular.element('#lanche').bind('click',function(){
				$scope.adicionaLanche();
			});
			angular.element('#almoco').click(function(){
				$scope.adicionaAlmoco();
			});
			
			//Implementação da Função adiciona lanche 
			$scope.adicionaLanche = function(){
				angular.element('.resultado').slideUp();
				angular.element('h3#lanche').show();
				if(angular.element('.lanche-form').length == 0){
					angular.element('h3#lanche').after($scope.DivLancheHtml());
				}else{
					angular.element('.lanche-form:last').after($scope.DivLancheHtml());
					$scope.moveTelaPara('.lanche-form:last');
				}
				$scope.trocaTipoDoCampo();
				$scope.temLanche = true;
				angular.element('.lanche-form .remove').bind('click',function(event){
					angular.element(event.target.parentElement).remove();
					angular.element('.resultado').slideUp();
					if(angular.element('.lanche-form').length == 0){
						angular.element('h3#lanche').hide();
						$scope.temLanche = false;
					}
				});
				angular.element('.lanche-form input').bind('focus',function($event){
					$scope.InicializaCampos($event);
				});
			}
			
			//Implementação da Função adiciona almoco
			$scope.adicionaAlmoco = function(){
				angular.element('.resultado').slideUp();
				angular.element('#almoco').unbind('click');
				angular.element('h3#almoco').show();
				angular.element('h3#almoco').after($scope.DivAlmocoHtml());
				angular.element('#almoco').css('opacity','0.5');
				$scope.trocaTipoDoCampo();
				$scope.temAlmoco = true;
				angular.element('.almoco-form .remove').bind('click',function(event){
					angular.element(event.target.parentElement).remove();
					angular.element('h3#almoco').hide();
					$scope.temAlmoco = false;
					angular.element('#almoco').css('opacity','1');
					angular.element('.resultado').slideUp();
					$scope.adicionaEventoDaFuncaoAdicionaAlmoco();
				});
				angular.element('#horaDeSaidaAlmoco').bind('focus',function($event){
					var min = angular.element('#horaDeEntrada').val();
					angular.element('#horaDeSaidaAlmoco').attr({"min":min,"max":"23:59"});
					angular.element('#horaDeSaidaAlmoco').val(min);
				});
				angular.element('#horaDeSaidaAlmoco').bind('change',function(){
					angular.element('#horaDeChegadaAlmoco').val("");
				});
				angular.element('#horaDeChegadaAlmoco').bind('focus',function(){
					var min = angular.element('#horaDeSaidaAlmoco').val();
					angular.element('#horaDeChegadaAlmoco').attr({"min":min,"max":"23:59"});
					angular.element('#horaDeChegadaAlmoco').val(min);
				});
			};
			
			//Função que acopla novamente evento ao item almoço do menu
			$scope.adicionaEventoDaFuncaoAdicionaAlmoco = function(){
				angular.element('#almoco').bind('click',function(){
					$scope.adicionaAlmoco();
				});
			};
			
			$scope.InicializaCampos = function($event){
				var target = angular.element($event.target);
				var targetSimbling = angular.element($event.target).siblings('input');
				var minRequired = angular.element($event.target).parent().parent().find("#horaDeEntrada");
				if(target.attr('id') == 'horaDeSaidaLanche'){
					if(target.val() < minRequired.val()){
						target.attr('min',minRequired.val());
						target.val(minRequired.val());
					}
				}else{
					if(targetSimbling.val() > target.val()){
						target.attr('min',targetSimbling.val());
						target.val(targetSimbling.val());
					}
				}
				/*console.log(target);
				console.log(minRequired);
				var inputs = angular.element('input');
				for(var i=2;i<inputs.length;i++){
					minInputValue = angular.element('input').eq(i-1).val();
					if(angular.element('input').eq(i).val() < minInputValue){
						angular.element('input').eq(i).attr('min',minInputValue);
						angular.element('input').eq(i).val(minInputValue);
					}
				}*/
			};
			
			//função que valida os campos do formulário
			$scope.verificaCampos = function(){
				var inputs = angular.element('input');
				var count = 0;
				for(var index=0;index<inputs.length;index++){
					var inputValue = angular.element('input').eq(index).val();
					var minInputValue = angular.element('input').eq(index).attr('min');
					var maxInputValue = angular.element('input').eq(index).attr('max');
					if(index>1){
						minInputValue = angular.element('input').eq(index-1).val();
					}
					if(angular.element('input').eq(index).val() == ""){
						var id = "#" + angular.element('input').eq(index).attr("id");
						$scope.marcaInvalido('input',index,"Informe as horas necessárias");
						count += 1; 
					}else if((inputValue > maxInputValue) || (inputValue < minInputValue)){
						var id = "#" + angular.element('input').eq(index).attr("id");
						if(inputValue > maxInputValue){
							$scope.marcaInvalido('input',index,"Horas precisam estar dentro do limite máximo");
						}else{
							$scope.marcaInvalido('input',index,"Horas não podem ser menores que campos anteriores");
						}
						$scope.moveTelaPara('.div-box-header');
						count += 1; 
					}else{
						angular.element('input').eq(index).removeClass('invalid');
					}
				}
				if(count == 0){
					$scope.marcaValido();
				}
			}
			
			//Marca campos como válidos
			$scope.marcaValido = function(){
				angular.element('#CalcularHora').attr('disabled',false);
				angular.element('.error').slideUp(1000);
				angular.element('input').removeClass('invalid');
				angular.element('input').addClass('valid');
			}
			
			//Marca campos como inválidos
			$scope.marcaInvalido = function(field, message){
				angular.element(field).removeClass('valid');
				angular.element(field).addClass('invalid');
				angular.element('#CalcularHora').attr('disabled',true);
				angular.element('.error span').text(message);
				angular.element('.error').slideDown(1000);
			}
			//Marca campos como inválidos
			$scope.marcaInvalido = function(field,index, message){
				angular.element(field).removeClass('valid');
				angular.element(field).eq(index).addClass('invalid');
				angular.element('#CalcularHora').attr('disabled',true);
				angular.element('.error span').text(message);
				angular.element('.error').slideDown(1000);
			}
			
			//Valida Campos
			$scope.validaInputHorasParaTrabalhar = function(){
				if($scope.hora.minutosParaTrabalhar > 60 || $scope.hora.minutosParaTrabalhar < 0 || $scope.hora.horasParaTrabalhar < 0
						|| ($scope.hora.horasParaTrabalhar >= 24 && $scope.hora.minutosParaTrabalhar > 0)
						|| (isNaN($scope.hora.horasParaTrabalhar) || isNaN($scope.hora.minutosParaTrabalhar))){
					return true;
				}
				return false;
			}
			
			$scope.validaInputHoraDeEntrada = function(){
				if($scope.hora.minutosDeEntrada > 60 || $scope.hora.minutosDeEntrada < 0 || $scope.hora.horaDeEntrada < 0
						|| ($scope.hora.horaDeEntrada >= 24 && $scope.hora.minutosDeEntrada > 0)
						|| (isNaN($scope.hora.horaDeEntrada) || isNaN($scope.hora.minutosDeEntrada))){
					return true;
				}
				return false;
			}
			
			//função que ler os campos do formulário
			$scope.lerCamposIniciais = function(){
				var horasTrabalhadas = angular.element("#horasParaTrabalhar").val();
				var horasEntrada = angular.element("#horaDeEntrada").val();
				
				$scope.hora.minutosParaTrabalhar = parseInt(horasTrabalhadas.slice(3));
				$scope.hora.minutosDeEntrada = parseInt(horasEntrada.slice(3));
				$scope.hora.horasParaTrabalhar = parseInt(horasTrabalhadas.slice(0,2));
				$scope.hora.horaDeEntrada = parseInt(horasEntrada.slice(0,2));
			}
			
			//Função que Calcula Almoco
			$scope.calculaAlmoco = function(){
				var horasSaidaAlmoco = angular.element("#horaDeSaidaAlmoco").val();
				var horasChegadaAlmoco = angular.element("#horaDeChegadaAlmoco").val();
				
				var SaidaAlmocoMinuto = parseInt(horasSaidaAlmoco.slice(3));
				var ChegadaAlmocoMinuto = parseInt(horasChegadaAlmoco.slice(3));
				var SaidaAlmocoHora = parseInt(horasSaidaAlmoco.slice(0,2));
				var ChegadaAlmocoHora = parseInt(horasChegadaAlmoco.slice(0,2));
				
				var horaTrabalhadaParteOne = SaidaAlmocoHora - $scope.hora.horaDeEntrada; 
				var minutosTrabalhadosParteOne = SaidaAlmocoMinuto - $scope.hora.minutosDeEntrada; 
				
				$scope.hora.horasParaTrabalhar -= horaTrabalhadaParteOne; 
				$scope.hora.minutosParaTrabalhar -= minutosTrabalhadosParteOne; 
				$scope.hora.horaDeEntrada = ChegadaAlmocoHora;
				$scope.hora.minutosDeEntrada = ChegadaAlmocoMinuto;
			}
			
			//Função que Calcula Lanche
			$scope.calculaLanche = function(){
				var saidaLanche,chegadaLanche,saidaLancheHora,saidaLancheMinuto,chegadaLancheHora,chegadaLancheMinuto;
				var horaTrabalhadaParteTwo,minutosTrabalhadosParteTwo;
				for(var i=0; i< angular.element('.lanche-form').length;i++){
					saidaLanche = angular.element('.lanche-form').eq(i).children('#horaDeSaidaLanche').val();
					chegadaLanche = angular.element('.lanche-form').eq(i).children('#horaDeChegadaLanche').val();
					
					saidaLancheHora = parseInt(saidaLanche.slice(0,2));
					saidaLancheMinuto = parseInt(saidaLanche.slice(3));
					chegadaLancheHora = parseInt(chegadaLanche.slice(0,2));
					chegadaLancheMinuto = parseInt(chegadaLanche.slice(3));
										
					horaTrabalhadaParteTwo = saidaLancheHora - $scope.hora.horaDeEntrada; 
					minutosTrabalhadosParteTwo = saidaLancheMinuto - $scope.hora.minutosDeEntrada; 
					
					$scope.hora.horasParaTrabalhar -= horaTrabalhadaParteTwo; 
					$scope.hora.minutosParaTrabalhar -= minutosTrabalhadosParteTwo; 
					$scope.hora.horaDeEntrada = chegadaLancheHora;
					$scope.hora.minutosDeEntrada = chegadaLancheMinuto;
				}
				
			}
			
			//Função que Calcula Saida Prevista
			$scope.calculaSaidaPrevista = function(){
				$scope.hora.horaPrevistaDeSaida = $scope.hora.horaDeEntrada + $scope.hora.horasParaTrabalhar;
				$scope.hora.minutoPrevistoDeSaida = $scope.hora.minutosDeEntrada + $scope.hora.minutosParaTrabalhar;
			}
			
			//Função que formata Saida Prevista
			$scope.formataSaidaPrevista = function(){
				if( $scope.hora.minutoPrevistoDeSaida >= 60){
					var dividendo = parseInt($scope.hora.minutoPrevistoDeSaida / 60); 
					var resto = $scope.hora.minutoPrevistoDeSaida % 60;
					$scope.hora.horaPrevistaDeSaida += dividendo;
					$scope.hora.minutoPrevistoDeSaida = resto;
				}
				if($scope.hora.horaPrevistaDeSaida > 23){
					$scope.hora.horaPrevistaDeSaida = $scope.hora.horaPrevistaDeSaida - 24;
					if(angular.element('.div-box-footer p').val() != undefined){
						angular.element('.div-box-footer p').text('No próximo dia');
					}else{
						angular.element('#HoraDeSaidaPrevista').after('<p>No próximo dia</p>');
					}
				}else{
					angular.element('.div-box-footer p').remove();
				}
				$scope.hora.horaPrevistaDeSaida = $scope.hora.horaPrevistaDeSaida < 10 ? "0"+$scope.hora.horaPrevistaDeSaida : $scope.hora.horaPrevistaDeSaida; 
				$scope.hora.minutoPrevistoDeSaida = $scope.hora.minutoPrevistoDeSaida < 10 ? "0"+$scope.hora.minutoPrevistoDeSaida : $scope.hora.minutoPrevistoDeSaida;
				
				$scope.tempoPrevistoDeSaida = $scope.hora.horaPrevistaDeSaida +":"+$scope.hora.minutoPrevistoDeSaida;
				
			}
			
			//Função Calcula hora
			$scope.calcularHora = function(){
				$scope.lerCamposIniciais();
				angular.element('.resultado').slideDown();
				if( $scope.temAlmoco == true){
					$scope.calculaAlmoco();
				}
				if( $scope.temLanche == true){
					$scope.calculaLanche();
				}
				
				$scope.calculaSaidaPrevista();
				$scope.formataSaidaPrevista();
				$scope.moveTelaPara('#HoraDeSaidaPrevista');
			}
			$scope.moveTelaPara = function(id){
				window.scroll(0,angular.element(id)[0].offsetTop);
			}
		});
	</script>
	<style>
	.container{
		background-color: white;
	}
	.container-box{
		display: block;
		width: 400px;
		margin: auto;
		/*margin-top:100px;*/
		border: 1px solid lightgrey;
		border-radius: 5px;
		padding: 5px 0px;
		background-color: lightseagreen;
	}
	.div-box-header{
		border:0;
		border-bottom: 1px solid lightgray;
		margin-bottom: 5px;
	}
	.div-box-header span{
		display: inline-block;
	}
	.div-box-header span.options{
		float: right;
		margin-right: 12px;
		margin-top: 12px;
		height: 35px;
		width: 35px;
		background: url(https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqg2zc6VJoBUtBItdjGtpmpR-6H9IoiHBD3v620Oanog9AYOUV);
		background-clip: content-box;
		background-size: 20px;
		background-repeat: no-repeat;
		background-position: center;
		box-shadow: 0px 0px 0.5px grey inset;
		padding: 2px;
		cursor:pointer;
	}
	.div-box-header span.options:hover{
		outline: 1px solid lightgray; 
	}
	span.remove{
		float: left;
		margin-left: 32px;
		margin-top: -62px;
		height: 35px;
		width: 35px;
		background: url(https://cdn4.iconfinder.com/data/icons/icocentre-free-icons/114/f-cross_256-128.png);
		background-clip: content-box;
		background-size: 20px;
		background-repeat: no-repeat;
		background-position: center;
		box-shadow: 0px 0px 0.5px grey inset;
		padding: 2px;
		cursor: pointer;
	}
	span.remove:hover{
		outline: 1px solid lightgray; 
	}
	.div-box-header span.titulo{
		margin-left: 60px;
		color:lightseagreen;
		font-size: 20px;
		font-weight: bold;
		padding: 20px 10px
	}
	.div-box-footer{
		border:0;
		border-top: 1px solid lightgray;
		margin-top: 5px;
		text-align: center;
	}
	.div-box-hora-entrada{
		margin-top: 10px;
	}
	.div-box-button{
		background-color: lightseagreen;
		padding: 10px;
	}
	.input-box{
		/*display: block;*/
		width: 50%;
		text-align: center;
		font-size: 15px;
		border: 0px;
		padding: 8px 15px;
		margin: auto;
		border-radius: 10px;
		box-shadow: 0px 0px 6px #BBB;
		color:lightseagreen;
		font-size:15px;
	}
	.button-box{
		display: block;
		width: 100%;
		margin: auto;
		/*padding: 10px 0px;*/
		font-size: 15px;
		font-weight: bold;
		background-color: lightseagreen;
		border-radius: 10px;
		color: white;
		border: 0px;
		cursor: pointer;
	}
	.input-box:focus{
		outline: 0px;
	}
	.h1-box{
		width: 30%;
		border-radius: 10px;
		color: white;
		box-shadow: 0px 0px 3px darkgrey;
		padding: 5px;
		background-color: darkseagreen;
		margin: auto;
	}
	h3{
		color: seagreen;
		text-align:center;
	}
	.display-none{
		display: none;
	}
	.error{
		background-color:red;
		height:40px;
		color:white;
		margin-top:-2px;
		padding-top:10px;
		box-sizing:border-box;
		font-size:18px;
		text-align: center;
	}
	.invalid{
		box-shadow: 0px 0px 6px red;
	}
	.valid{
		box-shadow: 0px 0px 6px seagreen;
	}
	body{
		background-color:rgba(192,192,192,0.1);
		background-image: url(./quandosairfundo2.png);
		background-size:cover;
		background-repeat: no-repeat;
	}
	.menu{
		z-index: 100;
		outline: 1px solid lightgray;
		box-shadow: 0px 0px 0.5px grey inset;
		float: right;
		margin-top: -12px;
		background-color: white;
		position: absolute;
		left: 773px;
	}
	.menu li{
		list-style-type: none;
		padding: 2px 17px 0px 4px;
		text-align: center;
		cursor: pointer;
		color:#666;
	}
	.menu li span{
		background-image: url(http://cdn.mysitemyway.com/etc-mysitemyway/icons/legacy-previews/icons/3d-transparent-glass-icons-alphanumeric/068116-3d-transparent-glass-icon-alphanumeric-plus-sign-simple.png);
		padding: 7px;
		background-size: contain;
		margin-right: 10px;
		float: left;
	}
	.div{
		padding: 15px 0px;
		display: block;
		text-align: center;
	}
	.light-blue-opacity{
		background-color: rgba(200, 200, 230, 0.0980392);
	}
	.margin-bottom-15px{
		margin-bottom: 15px;
	}
	</style>
</head>
<body ng-app="minhaCalculadoraDeHoras" ng-controller="CalculadoraDeHora">
	<div class="container-box">
		<div class="container">
			<div class="div-box-header" style="">
				<span class="titulo">Calculadora de Hora de Saída</span>
				<span class="options"></span>
				<div class="menu">
					<li style="outline: 1px solid lightgray;" id="almoco"><span></span>Almoco</li>
					<li id="lanche"><span></span>Lanche</li>
				</div>
			</div>
			<div class="error">
				<span>Informe as horas necessárias</span>
			</div>
			<div class="div-box-hora-entrada div">
				<input id="horasParaTrabalhar" class="input-box required margin-bottom-15px" type="text" placeholder="Horas a trabalhar" title="Horas a trabalhar"/><br>
				<input id="horaDeEntrada" class="input-box required" type="text" placeholder="Hora de Entrada" title="Hora de Entrada"/><br>
			</div>
			<h3 id="almoco">Almoco</h3>
			<h3 id="lanche">Lanche</h3>	
			
			<div class="div-box-button">
				<button id="CalcularHora" class="button-box" ng-click="calcularHora()">Calcular</button>
			</div>
			<div class="div-box-footer" style="padding: 0px 0px 10px">
				<h3 class="resultado" style="margin-top: 10px;">Hora de Saída Prevista:</h3>
				<h1 id="HoraDeSaidaPrevista" class="h1-box resultado">{{tempoPrevistoDeSaida}}</h1>
			</div>
		</div>
	</div>
</body>
</html>
