<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Quando Sair?</title>
	<link rel='icon' href="https://images.vexels.com/media/users/3/131904/isolated/preview/314ac7a195e5759f2cfadde070a92cc7-reloading-timer-clock-icon-by-vexels.png">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>
	<script type="text/javascript">
		if(typeof jQuery === 'undefined'){
			alert('jQuery não foi carregado');
		}else if(typeof angular === 'undefined'){
			alert('angular não foi carregado');
		}else if(typeof moment === 'undefined'){
			alert('moment não foi carregado');
		}
		
		var app = angular.module('minhaCalculadoraDeHoras', []);
		app.controller('CalculadoraDeHora', function($scope, $http) {
			//inicializa hora e dados
			$scope.temAlmoco = false;
			$scope.temLanche = false;
			angular.element('.error').hide();
			angular.element('.menu').hide();
			angular.element('.div-box').hide();
			angular.element('.resultado').hide();
			angular.element('h3#lanche').hide();
			angular.element('h3#almoco').hide();
			
			//Verifica Campos 
			angular.element('.div-box-button').mouseenter(function(){
				$scope.verificaCampos();
			});
			
			//Mostra Menu
			angular.element('.options').hover(function(){
				angular.element('.menu').show();
				angular.element('.menu').mouseleave(function(){
					angular.element('.menu').fadeOut();
				});
			});
			//Mostra Itens do Menu
			angular.element('.options').hover(function(){
				angular.element('.menu').show();
				angular.element('.menu').mouseleave(function(){
					angular.element('.menu').fadeOut();
				});
			});
			
			//Altera Tipo dos Campos
			$scope.trocaTipoDoCampo = function(){
				angular.element('input').bind('blur',function($event){
					angular.element($event.target).attr("type","text");
					angular.element($event.target).css("padding", "8px 15px");
				});
				angular.element('input').bind('focus',function($event){
					angular.element($event.target).attr("type","time");
					angular.element($event.target).css("padding", "5px 0px 5px 30px");
				});
			}
			//Limpa Campos dependentes Após Alteração da Hora de Entrada 
			angular.element('#horaDeEntrada').change(function(){
				angular.element('.almoco-form input').val("");
				angular.element('.lanche-form input').val("");
			});
			
			//Cria Html da div lanche
			$scope.DivLancheHtml = function(){
				return '<div class="div-box div light-blue-opacity lanche-form" style="">'
					+'<input id="horaDeSaidaLanche" class="horaDeSaidaLanche input-box margin-bottom-15px ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Saída p/ Lanche" title="Hora de Saída p/ Lanche"><br>'
					+'<input id="horaDeChegadaLanche" class="horaDeChegadaLanche input-box ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Chegada do Lanche" title="Hora de Chegada do Lanche"><br>'
					+'<span class="remove" ng-click="remove($event)"></span></div>';
			}
			//Cria Html da div Almoco
			$scope.DivAlmocoHtml = function(){
				return '<div class="div-box div light-blue-opacity almoco-form" style="">'
					+'<input id="horaDeSaidaAlmoco" class="input-box margin-bottom-15px ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Saída p/ Almoco" title="Hora de Saída p/ Almoco"><br>'
					+'<input id="horaDeChegadaAlmoco" class="input-box ng-pristine ng-untouched ng-valid ng-empty" type="text" placeholder="Hora de Chegada do Almoco" title="Hora de Chegada do Almoco" min="10:00" max="12:00"><br>'
					+'<span class="remove" ng-click="remove($event)"></span></div>';
			}
			
			//Funções que adiciona almoço e lanche
			angular.element('#lanche').bind('click',function(){
				$scope.adicionaLanche();
			});
			angular.element('#almoco').click(function(){
				$scope.adicionaAlmoco();
			});
			
			//Implementação da Função adiciona lanche 
			$scope.adicionaLanche = function(){
				angular.element('.resultado').slideUp();
				angular.element('h3#lanche').show();
				if(angular.element('.lanche-form').length == 0){
					angular.element('h3#lanche').after($scope.DivLancheHtml());
				}else{
					angular.element('.lanche-form:last').after($scope.DivLancheHtml());
					$scope.moveTelaPara('.lanche-form:last');
				}
				$scope.trocaTipoDoCampo();
				$scope.temLanche = true;
				angular.element('.lanche-form .remove').bind('click',function(event){
					angular.element(event.target.parentElement).remove();
					angular.element('.resultado').slideUp();
					if(angular.element('.lanche-form').length == 0){
						angular.element('h3#lanche').hide();
						$scope.temLanche = false;
					}
				});
				angular.element('.lanche-form input').bind('focus',function($event){
					$scope.InicializaCampos($event);
				});
			}
			
			//Implementação da Função adiciona almoco
			$scope.adicionaAlmoco = function(){
				angular.element('.resultado').slideUp();
				angular.element('#almoco').unbind('click');
				angular.element('h3#almoco').show();
				angular.element('h3#almoco').after($scope.DivAlmocoHtml());
				angular.element('#almoco').css('opacity','0.5');
				$scope.trocaTipoDoCampo();
				$scope.temAlmoco = true;
				angular.element('.almoco-form .remove').bind('click',function(event){
					angular.element(event.target.parentElement).remove();
					angular.element('h3#almoco').hide();
					$scope.temAlmoco = false;
					angular.element('#almoco').css('opacity','1');
					angular.element('.resultado').slideUp();
					$scope.adicionaEventoDaFuncaoAdicionaAlmoco();
				});
				angular.element('#horaDeSaidaAlmoco').bind('focus',function($event){
					var min = angular.element('#horaDeEntrada').val();
					angular.element('#horaDeSaidaAlmoco').attr({"min":min,"max":"23:59"});
					angular.element('#horaDeSaidaAlmoco').val(min);
				});
				angular.element('#horaDeSaidaAlmoco').bind('change',function(){
					angular.element('#horaDeChegadaAlmoco').val("");
				});
				angular.element('#horaDeChegadaAlmoco').bind('focus',function(){
					var min = angular.element('#horaDeSaidaAlmoco').val();
					angular.element('#horaDeChegadaAlmoco').attr({"min":min,"max":"23:59"});
					angular.element('#horaDeChegadaAlmoco').val(min);
				});
			};
			
			//Função que acopla novamente evento ao item almoço do menu
			$scope.adicionaEventoDaFuncaoAdicionaAlmoco = function(){
				angular.element('#almoco').bind('click',function(){
					$scope.adicionaAlmoco();
				});
			};
			
			$scope.InicializaCampos = function($event){
				var target = angular.element($event.target);
				var targetSimbling = angular.element($event.target).siblings('input');
				var minRequired = angular.element($event.target).parent().parent().find("#horaDeEntrada");
				if(target.attr('id') == 'horaDeSaidaLanche'){
					if(target.val() < minRequired.val()){
						target.attr('min',minRequired.val());
						target.val(minRequired.val());
					}
				}else{
					if(targetSimbling.val() > target.val()){
						target.attr('min',targetSimbling.val());
						target.val(targetSimbling.val());
					}
				}
			};
			
			//função que valida os campos do formulário
			$scope.verificaCampos = function(){
				var inputs = angular.element('input');
				var count = 0;
				for(var index=0;index<inputs.length;index++){
					var inputValue = angular.element('input').eq(index).val();
					var minInputValue = angular.element('input').eq(index).attr('min');
					var maxInputValue = angular.element('input').eq(index).attr('max');
					if(index>1){
						minInputValue = angular.element('input').eq(index-1).val();
					}
					if(angular.element('input').eq(index).val() == ""){
						var id = "#" + angular.element('input').eq(index).attr("id");
						$scope.marcaInvalido('input',index,"Informe as horas necessárias");
						count += 1; 
					}else if((inputValue > maxInputValue) || (inputValue < minInputValue)){
						var id = "#" + angular.element('input').eq(index).attr("id");
						if(inputValue > maxInputValue){
							$scope.marcaInvalido('input',index,"Horas precisam estar dentro do limite máximo");
						}else{
							$scope.marcaInvalido('input',index,"Horas não podem ser menores que campos anteriores");
						}
						$scope.moveTelaPara('.div-box-header');
						count += 1; 
					}else{
						angular.element('input').eq(index).removeClass('invalid');
					}
				}
				if(count == 0){
					$scope.marcaValido();
				}
			}
			
			//Marca campos como válidos
			$scope.marcaValido = function(){
				angular.element('#CalcularHora').attr('disabled',false);
				angular.element('.error').slideUp(1000);
				angular.element('input').removeClass('invalid');
				angular.element('input').addClass('valid');
			}
			
			//Marca campos como inválidos
			$scope.marcaInvalido = function(field,index, message){
				angular.element(field).removeClass('valid');
				angular.element(field).eq(index).addClass('invalid');
				angular.element('#CalcularHora').attr('disabled',true);
				angular.element('.error span').text(message);
				angular.element('.error').slideDown(1000);
			}
			
			//Função que Adiciona horas
			$scope.adicionaHoras = function(horasTrabalhar,tempoParaSubtrair){
				return moment(horasTrabalhar).add({ hours: tempoParaSubtrair.hours(), minutes: tempoParaSubtrair.minute()});
			}
			
			//Função que Calcula Almoco
			$scope.calculaAlmoco = function(horasTrabalhar){
				var saidaAlmoco = moment(angular.element("#horaDeSaidaAlmoco").val(),"HH:mm");
				var chegadaAlmoco = moment(angular.element("#horaDeChegadaAlmoco").val(),"HH:mm");
				var almoco = moment(moment.utc(moment(chegadaAlmoco).diff(moment(saidaAlmoco))).format("HH:mm"),"HH:mm");
				return $scope.adicionaHoras(horasTrabalhar, almoco);
			}
			
			//Função que Calcula Lanche
			$scope.calculaLanche = function(saida){
				for(var i=0 ; i<angular.element(".horaDeSaidaLanche").length; i++){
					var saidaLanche = moment(angular.element(".horaDeSaidaLanche").eq(i).val(),"HH:mm");
					var chegadaLanche = moment(angular.element(".horaDeChegadaLanche").eq(i).val(),"HH:mm");
					var lanche = moment(moment.utc(moment(chegadaLanche).diff(moment(saidaLanche))).format("HH:mm"),"HH:mm");
					saida = $scope.adicionaHoras(saida, lanche);  
				}
				return saida;
			}
			
			//Função que Calcula Saida Prevista
			$scope.calculaSaidaPrevista = function(){
				var horasTrabalhar = moment(angular.element('#horasParaTrabalhar').val(),"HH:mm");
				var entrada = moment(angular.element("#horaDeEntrada").val(),"HH:mm");
				var saida;
				
				if($scope.temAlmoco){
					saida = $scope.calculaAlmoco(horasTrabalhar);
				}
				if($scope.temLanche){
					if(saida != undefined){
						saida = $scope.calculaLanche(saida);
					}else{
						saida = $scope.calculaLanche(horasTrabalhar);
					}
				}
				if(saida != undefined){
					$scope.tempoPrevistoDeSaida = $scope.adicionaHoras(entrada,saida).format("HH:mm");
				}else{
					$scope.tempoPrevistoDeSaida = $scope.adicionaHoras(entrada,horasTrabalhar).format("HH:mm");
				}
			}
			
			//Função Calcula hora
			$scope.calcularHora = function(){
				angular.element('.resultado').slideDown();
				$scope.calculaSaidaPrevista();
				$scope.moveTelaPara('#HoraDeSaidaPrevista');
			}
			$scope.moveTelaPara = function(id){
				window.scroll(0,angular.element(id)[0].offsetTop);
			}
			
			$scope.trocaTipoDoCampo();
		});
	</script>
	<style>
	.container{
		background-color: white;
	}
	.container-box{
		display: block;
		width: 400px;
		margin: auto;
		/*margin-top:100px;*/
		border: 1px solid lightgrey;
		border-radius: 5px;
		padding: 5px 0px;
		background-color: lightseagreen;
	}
	.div-box-header{
		border:0;
		border-bottom: 1px solid lightgray;
		margin-bottom: 5px;
	}
	.div-box-header span{
		display: inline-block;
	}
	.div-box-header span.options{
		float: right;
		margin-right: 12px;
		margin-top: 12px;
		height: 35px;
		width: 35px;
		background: url(https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqg2zc6VJoBUtBItdjGtpmpR-6H9IoiHBD3v620Oanog9AYOUV);
		background-clip: content-box;
		background-size: 20px;
		background-repeat: no-repeat;
		background-position: center;
		box-shadow: 0px 0px 0.5px grey inset;
		padding: 2px;
		cursor:pointer;
	}
	.div-box-header span.options:hover{
		outline: 1px solid lightgray; 
	}
	span.remove{
		float: left;
		margin-left: 32px;
		margin-top: -62px;
		height: 35px;
		width: 35px;
		background: url(https://cdn4.iconfinder.com/data/icons/icocentre-free-icons/114/f-cross_256-128.png);
		background-clip: content-box;
		background-size: 20px;
		background-repeat: no-repeat;
		background-position: center;
		box-shadow: 0px 0px 0.5px grey inset;
		padding: 2px;
		cursor: pointer;
	}
	span.remove:hover{
		outline: 1px solid lightgray; 
	}
	.div-box-header span.titulo{
		margin-left: 60px;
		color:lightseagreen;
		font-size: 20px;
		font-weight: bold;
		padding: 20px 10px
	}
	.div-box-footer{
		border:0;
		border-top: 1px solid lightgray;
		margin-top: 5px;
		text-align: center;
	}
	.div-box-hora-entrada{
		margin-top: 10px;
	}
	.div-box-button{
		background-color: lightseagreen;
		padding: 10px;
	}
	.input-box{
		/*display: block;*/
		width: 50%;
		text-align: center;
		font-size: 15px;
		border: 0px;
		padding: 8px 15px;
		margin: auto;
		border-radius: 10px;
		box-shadow: 0px 0px 6px #BBB;
		color:lightseagreen;
		font-size:15px;
	}
	.button-box{
		display: block;
		width: 100%;
		margin: auto;
		/*padding: 10px 0px;*/
		font-size: 15px;
		font-weight: bold;
		background-color: lightseagreen;
		border-radius: 10px;
		color: white;
		border: 0px;
		cursor: pointer;
	}
	.input-box:focus{
		outline: 0px;
	}
	.h1-box{
		width: 30%;
		border-radius: 10px;
		color: white;
		box-shadow: 0px 0px 3px darkgrey;
		padding: 5px;
		background-color: darkseagreen;
		margin: auto;
	}
	h3{
		color: seagreen;
		text-align:center;
	}
	.display-none{
		display: none;
	}
	.error{
		background-color:red;
		height:40px;
		color:white;
		margin-top:-2px;
		padding-top:10px;
		box-sizing:border-box;
		font-size:18px;
		text-align: center;
	}
	.invalid{
		box-shadow: 0px 0px 6px red;
	}
	.valid{
		box-shadow: 0px 0px 6px seagreen;
	}
	body{
		background-color:rgba(192,192,192,0.1);
		background-image: url(./quandosairfundo2.png);
		background-size:cover;
		background-repeat: no-repeat;
	}
	.menu{
		z-index: 100;
		outline: 1px solid lightgray;
		box-shadow: 0px 0px 0.5px grey inset;
		margin-top: -12px;
		background-color: white;
		width: 145px;
		left: 54.3%;
		position: absolute;
	}
	.menu li{
		list-style-type: none;
		padding: 2px 17px 0px 4px;
		text-align: center;
		cursor: pointer;
		color:#666;
	}
	.menu li span{
		background-image: url(http://cdn.mysitemyway.com/etc-mysitemyway/icons/legacy-previews/icons/3d-transparent-glass-icons-alphanumeric/068116-3d-transparent-glass-icon-alphanumeric-plus-sign-simple.png);
		padding: 7px;
		background-size: contain;
		margin-right: 10px;
		float: left;
	}
	.div{
		padding: 15px 0px;
		display: block;
		text-align: center;
	}
	.light-blue-opacity{
		background-color: rgba(200, 200, 230, 0.0980392);
	}
	.margin-bottom-15px{
		margin-bottom: 15px;
	}
	</style>
</head>
<body ng-app="minhaCalculadoraDeHoras" ng-controller="CalculadoraDeHora">
	<div class="container-box">
		<div class="container">
			<div class="div-box-header" style="">
				<span class="titulo">Calculadora de Hora de Saída</span>
				<span class="options"></span>
				<div class="menu">
					<li style="outline: 1px solid lightgray;" id="almoco"><span></span>Almoco</li>
					<li id="lanche"><span></span>Lanche</li>
				</div>
			</div>
			<div class="error">
				<span>Informe as horas necessárias</span>
			</div>
			<div class="div-box-hora-entrada div">
				<input id="horasParaTrabalhar" class="input-box required margin-bottom-15px" type="text" placeholder="Horas a trabalhar" title="Horas a trabalhar"/><br>
				<input id="horaDeEntrada" class="input-box required" type="text" placeholder="Hora de Entrada" title="Hora de Entrada"/><br>
			</div>
			<h3 id="almoco">Almoco</h3>
			<h3 id="lanche">Lanche</h3>	
			
			<div class="div-box-button">
				<button id="CalcularHora" class="button-box" ng-click="calcularHora()">Calcular</button>
			</div>
			<div class="div-box-footer" style="padding: 0px 0px 10px">
				<h3 class="resultado" style="margin-top: 10px;">Hora de Saída Prevista:</h3>
				<h1 id="HoraDeSaidaPrevista" class="h1-box resultado">{{tempoPrevistoDeSaida}}</h1>
			</div>
		</div>
	</div>
</body>
</html>
